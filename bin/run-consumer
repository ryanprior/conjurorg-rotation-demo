#!/bin/bash

set -eux

export CONJUR_AUTHN_LOGIN=${DEMO_CONSUMER_ID:-tomcat-01}

# Rotate the api key for the consumer to connect to Conjur
token="$(docker-compose run --rm -T --no-deps conjur-cli \
                        hostfactory tokens create --duration-days=1 tomcat \
                        | jq -r .[].token | tr -d '\n')"
docker-compose run --rm -T --no-deps conjur-cli \
               hostfactory hosts create $token $CONJUR_AUTHN_LOGIN
export CONJUR_AUTHN_API_KEY=$(docker-compose run -T --no-deps conjur-cli \
    host rotate_api_key --host "$CONJUR_AUTHN_LOGIN" \
    | tr -d "\r\n")

docker-compose run --no-deps consumer $@
